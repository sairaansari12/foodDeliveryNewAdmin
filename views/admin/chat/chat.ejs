<!DOCTYPE html>
<html lang="en">
    <head>
        <style>
            .admin-center{
                width: 25%;
                position: fixed;
                top: 50%;
                left: 50%;
                word-wrap: break-word;
                background-color: #fff;
                border: 0 solid #f7f7f7;
                border-radius: .25rem;
                margin-top: -50px;
                margin-left: -100px;
            }
            .chat-btn{
                background: #5a9f5a;
                border: 1px solid #5a9f5a;
                color: white;
                padding: 8px;
                width: 102px;
                position: fixed;
                top: 60%;
                left: 50%;
                /* margin-top: -96px; */
            }
        </style>

        <%- include('../partials/header'); -%>

    </head>

    <body class="loading"
    data-layout='{"mode": "light", "width": "fluid", "menuPosition": "fixed", "sidebar": { "color": "light", "size": "default", "showuser": false}, "topbar": {"color": "dark"}, "showRightSidebarOnPageLoad": true}'>

        <!-- Begin page -->
        <div id="wrapper">
            <%- include('../partials/dashboardHeader'); -%>

            <!-- ============================================================== -->
            <!-- Start Page Content here -->
            <!-- ============================================================== -->

            <div class="content-page">
                <div class="content">

                    <!-- Start Content-->
                    <div class="container-fluid">
                        
                        <!-- start page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box">
                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item"><a href="<%- adminpath %>">Dashboard</a></li>
                                            <li class="breadcrumb-item active">Chat</li>
                                        </ol>
                                    </div>
                                    <h4 class="page-title">Chat</h4>
                                </div>
                            </div>
                        </div>     
                        <!-- end page title --> 
                        
                        <div class="admin-center" id="admin-center">
                            
                            <div data-simplebar style="max-height: 375px" id="chatlist"></div>
                        </div>
                        
                        <div class="row">
                            <!-- chat area -->
                            <div class="col-xl-12 col-lg-12" id="right-chat">

                                <div class="card">
                                    <div class="card-body py-2 px-3 border-bottom border-light">
                                        <div class="media py-1">
                                            
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <ul id="list" class="conversation-list" data-simplebar style="max-height: 460px; overflow: auto;">
                                                                              
                                            
                                        </ul>

                                        <div class="row">
                                            <div class="col">
                                                <div class="mt-2 bg-light p-3 rounded">
                                                    <form class="needs-validation" novalidate="" name="chat-form"
                                                        id="chat-form">
                                                        <div class="row">
                                                            <div class="col mb-2 mb-sm-0">
                                                                <input type="text" class="form-control border-0" placeholder="Enter your text" id="msg">
                                                                <div id="img" style="text-align: center;"></div>
                                                                <!-- <div class="invalid-feedback">
                                                                    Please enter your messsage
                                                                </div> -->
                                                            </div>
                                                            <div class="col-sm-auto">
                                                                <div class="btn-group">
                                                                    <a onclick="selectFile()" class="btn btn-light"><i class="fe-paperclip"></i></a>
                                                                    <input onchange="getImage(this)" id="file-upload" type="file" hidden />
                                                                    <button type="submit" class="btn btn-success chat-send btn-block"><i class='fe-send'></i></button>
                                                                </div>
                                                            </div> <!-- end col -->
                                                        </div> <!-- end row-->
                                                    </form>
                                                </div> 
                                            </div> <!-- end col-->
                                        </div>
                                        <!-- end row -->
                                    </div> <!-- end card-body -->
                                </div> <!-- end card -->
                            </div>
                            <!-- end chat area-->

                        </div> <!-- end row-->
                        
                    </div> <!-- container -->

                </div> <!-- content -->

            </div>

            <!-- ============================================================== -->
            <!-- End Page content -->
            <!-- ============================================================== -->


        </div>
        <!-- END wrapper -->

        <%- include('../partials/script'); -%>
        <%- include('../partials/commonJs'); -%>    
        
    </body>
    
</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
<script>
    //live link = http://51.79.40.224:9070/
    var socket = new io('http://localhost:9062/');
    var groupId, base64Img, extension, currentPage = 0;
    var chatListData = [];
    socket.on("newMessage", (data)=>{  
            
        if(data.senderId)
            var odd = data.senderId == '<%-id%>' ? true : false;
        else     
            var odd = data.adminId == '<%-id%>' ? true : false;
        var html = "";
        var sentAt = convertTime(data.sentAt);
        if(odd){
            html = ` <li class="clearfix odd">
                    <div class="chat-avatar">
                        <img src="/dist/assets/images/user.jpg" class="rounded" alt="${data.senderName ? data.senderName : data.adminName}" />
                        <i>${sentAt}</i>
                    </div>
                    <div class="conversation-text">
                        <div class="ctext-wrap">
                            <i>${data.senderName ? data.senderName : data.adminName}</i>`;
            if(data.type == 1){
                html = html + `<p>
                            ${data.message}
                            </p>
                        </div>
                    </div>          
                </li>`
            }  else{
                html = html + `<img style="width: 345px;height: 260px;" src="${data.media}" />
                        </div>
                    </div>                              
                </li>`
            }
        } else{
            html = ` <li class="clearfix">
                    <div class="chat-avatar">
                        <img src="/dist/assets/images/user.jpg" class="rounded" alt="${data.senderName ? data.senderName : data.adminName}" />
                        <i>${sentAt}</i>
                    </div>
                    <div class="conversation-text">
                        <div class="ctext-wrap">
                            <i>${data.senderName ? data.senderName : data.adminName}</i>`;
            if(data.type == 1){
                html = html + `<p>
                            ${data.message}
                            </p>
                        </div>
                    </div>          
                </li>`
            }  else{
                html = html + `<img style="width: 345px;height: 260px;" src="${data.media}" />
                        </div>
                    </div>                              
                </li>`
            }
        } 
        
      $('#list').append($(html));

    })
   
    $(document).ready(function(){  
      $("#chat img:last-child").remove();
        $("#right-chat").hide(); 
        getAdmin();
    });
    
    
    $('form').submit(function(e) {
      e.preventDefault();
      $("#msg").show();
      $("#img img:last-child").remove();
      if(base64Img && base64Img != ""){
        socket.emit("sendMessage", {authToken: '<%-token%>' , type: 2, media: base64Img,extension:extension, usertype: "admin",extraType: "vendor", groupId: groupId});
        base64Img = "";
      }else{
        socket.emit("sendMessage", {authToken: '<%-token%>' , type: 1, message: $('#msg').val(), usertype: "admin",extraType: "vendor", groupId: groupId});
      }
        
        $('#msg').val('');
      return false;
    });
    function getAdmin(){
        socket.emit('getAdmin',{authToken: '<%-token%>'});
        socket.on("getAdmin", data=>{
            console.log("=>>>chatList", data)
            chatListData = data;
            var userData = data;
            createChatList(userData);  
        })
    }
    function createChatList(data){
        var html = "", btn= "";
        for(var k=0;k<data.length;k++){
            btn = `<button class="chat-btn"  onclick="showmsg('${data[k].id}')">Start Chat</button>`;
            html = html + `<a href="javascript:void(0);" class="text-body">
                <div class="media p-2">
                    <img src="/dist/assets/images/user.jpg" class="mr-2 rounded-circle" height="42" alt="" />
                    <div class="media-body" onclick="showmsg('${data[k].id}')">
                        <h5 class="mt-0 mb-0 font-14">
                            <!-- <span class="float-right text-muted font-weight-normal font-12">4:30am</span> -->
                            ${data[k].name}
                        </h5>
                        <p class="mt-1 mb-0 text-muted font-14">
                            <!-- <span class="w-25 float-right text-right"><span class="badge badge-soft-danger">3</span></span> -->
                            <span class="w-75">${data[k].email} </span>
                            <div class="w-75">${data[k].phone} </div>
                        </p>
                    </div>
                </div>
            </a> `  
        }
        $('#chatlist').html(html);
        $("#chatlist").append(btn);
       
    }

    function showmsg(id){
        $("#right-chat").show();
        $("#admin-center").hide();
       var data = {
            authToken: '<%-token%>',
            receiverId: id
        }
       socket.emit('joinRoom',data);
       socket.on('joinRoom',(data)=>{
           groupId = data.groupId;
           socket.emit("chatHistory", {authToken: '<%-token%>', groupId: data.groupId, usertype: "admin"});
           socket.on("chatHistory", (data)=>{
               console.log("=>chatHistoryRes",  data);
               var html = "";
               for(var i = 0 ;  i <data.length ; i++){
                   var sentAt = convertTime(data[i].sentAt);
                   if(data[i].senderId)
                        var odd = data[i].senderId == '<%-id%>' ? true : false;
                   else     
                    var odd = data[i].adminId == '<%-id%>' ? true : false;
                if(odd){
                    html = html +  ` <li class="clearfix odd">
                            <div class="chat-avatar">
                                <img src="/dist/assets/images/user.jpg" class="rounded" alt="${data[i].senderName}" />
                                <i>${sentAt}</i>
                            </div>
                            <div class="conversation-text" style="width: 73% !important">
                                <div class="ctext-wrap">
                                    <i>${data[i].senderName ? data[i].senderName : data[i].adminName}</i>
                                    `;
                    if(data[i].type == 1){
                        html = html + `<p>
                                    ${data[i].message}
                                    </p>
                                </div>
                            </div>          
                        </li>`
                    }  else{
                        html = html + `<img style="width: 345px;height: 260px;" src="${data[i].media}" />
                             </div>
                            </div>                              
                        </li>`
                    }                                
                               
                }else{
                    html = html +  ` <li class="clearfix">
                            <div class="chat-avatar">
                                <img src="/dist/assets/images/user.jpg" class="rounded" alt="${data[i].senderName}" />
                                <i>${sentAt}</i>
                            </div>
                            <div class="conversation-text" style="width: 73% !important">
                                <div class="ctext-wrap">
                                    <i>${data[i].senderName ? data[i].senderName : data[i].adminName}</i>`;
                                   
                    if(data[i].type == 1){
                        html = html + `<p>
                                    ${data[i].message}
                                    </p>
                                </div>
                            </div>          
                        </li>`
                    }  else{
                        html = html + `<img style="width: 345px;height: 260px;" src="${data[i].media}" />
                             </div>
                            </div>                              
                        </li>`
                    } 
                }
                
               }
               $('#list').html(html)
           })
       });
       
    }
    function selectFile(){
        $("#file-upload").click();
    }
    function getImage(element){
        var img = element.files[0];
        extension = element.files[0].name.substring(element.files[0].name.lastIndexOf('.') + 1);
        var reader = new FileReader();  
        reader.onloadend = function() {
            base64Img = reader.result;
            $("#msg").hide();
            var html = `<img src="${base64Img}" style="width: 50%;" />`
            $("#img").html(html);
        }
        reader.readAsDataURL(img);
    }
    
   
    function convertTime(timeStamp){
        var unixtimestamp = timeStamp;
        var date = new Date(unixtimestamp*1000);
        var year = date.getFullYear();
        var month = date.getMonth();
        var day = date.getDate();
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var newformat = hours >= 12 ? 'PM' : 'AM';  
        hours = hours % 12;   
        hours = hours ? hours : 12;  
        minutes = minutes < 10 ? '0' + minutes : minutes;  
        // var convdataTime = month+'/'+day+'/'+year+' '+hours + ':' + minutes+ ' ' + newformat;
        var convdataTime = hours + ':' + minutes+ ' ' + newformat;
        return convdataTime;
    }
</script>